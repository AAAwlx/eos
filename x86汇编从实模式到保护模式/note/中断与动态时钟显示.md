# 中断与动态时钟显示

## 硬件中断
中断分为两种类型。一种是需要及时作出处理否则会影响到系统运行的非屏蔽中断。\
INTR：硬盘、鼠标、打印机、网卡等设备发出的中断信号，可通过 eflags 寄存器的 IF 位将所有这些外部设备的中断屏蔽。

NMI：电源掉电、内存读写错误、总线奇偶校验错误等灾难性的错误，不可屏蔽，CPU 必须立刻处理。
### 非屏蔽中断

当一个中断发生时，还应当知道到底是发生了什么事情。因此每种类型都会有相应的编号被称为中断向量表。但是由于非屏蔽中断非常紧急，并不需要系统作出过多处理，因此非屏蔽中断在实模式下有统一的中断号为2。\
### 屏蔽中断
一种是进程不希望被打断继而会延迟处理的屏蔽中断。该类中断的种类非常多。
由于相关的设备非常多，多个设备同时会产生不同的中断，但是从处理器只能处理一个中断，因此需要一个代理。\
中断控制器8259作为代理负责调度。8259中有一个中断屏蔽寄存器IMR。共8位，分别对应芯片中的8个引脚。主片的端口号是0x20和0x21。从片的端口号是0xa0和0xa1。\
除此之外一条指令能否被处理还要看标志位寄存器中的if位为0还是1。
可以通过 cli 和 sti 两条指令改变该位的值。
```asm
CLI ; 禁止中断
STI ; 允许中断
```
### 中断向量表
在实模式之中中断处理程序被放在内存的0x00000到0x003ff结束。每个中断在中断向量表中占两个字，一个表示段地址一个表示偏移地址\
8259芯片是可以编程来灵活改变引脚对应的中断编号但是不能单独进行。可指定主片的中断号从哪里开始。
8259芯片的
### 中断信号产生应该进行的操作
保护中断现场：先将标志位寄存器压栈保存，清除其中的if和tf位，再将cs和ip入桟保存。\
执行中断程序：将中断号乘四（一个中断号占四个字节）即为中断向量表中的偏移位置。\
返回原处执行：中断处理程序最后一条指令是iret，将战中数据逐个弹出返回原来的位置继续执行。并且将中断前的标志位寄存器的内容也一并恢复。
中断信号随时可能产生，
## 实时时钟
实时时钟由两个部分组成集成在芯片 ICH 中。一部分为 RTC 一部分为 CMOS RAM。计算机关闭后依然会有电池为实时时钟的跳动供电。RTC由晶振驱动，对CMOS RAM中存储的时间可以一秒钟刷新一次。
日期等信息存储在 CMOS RAM 中。
对于CMOS RAM的访问可以通过两个端口进行访问，索引端口0x70，0x74指定CMOS RAM内的存储单元。
0x70是只写端口，真正的数据读写是0x71端口对数据进行读写。

